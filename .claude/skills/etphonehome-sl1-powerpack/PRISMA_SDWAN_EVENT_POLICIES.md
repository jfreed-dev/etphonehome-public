# Prisma SD-WAN PowerPack - Event Policy Recommendations

## Overview

This document provides recommendations for SL1 Event Policies to properly handle alerts generated by the Prisma SD-WAN PowerPack. The Event Processor (DA 1937) generates alerts with classification tiers that should be processed by corresponding Event Policies.

## Current State

### DA-Defined Alerts (dynamic_app_alerts)

| aid | Alert Name | State | Notes |
|-----|------------|-------|-------|
| 1724 | API Credential Unauthorized | Disabled | Credential validation |
| 1724 | API Credential Okay | Disabled | Credential recovery |
| 1729 | Prisma Cloud Site is Disabled | **Enabled** | Site admin state |
| 1729 | Prisma Cloud Site is Active | **Enabled** | Site recovery |

### Event Processor Generated Alerts

The Event Processor calls `generate_alert()` with classified events. These alerts appear in SL1 with:
- **message**: Contains classification prefix (e.g., "[CARRIER_TICKET] Interface...")
- **yid**: Site name + element name
- **value**: Classification tier

## Recommended Event Policies

### Policy 1: CARRIER_TICKET - Circuit Failures

**Purpose:** Handle circuit/hardware failures requiring carrier engagement

```
Name: Prisma SD-WAN - Circuit Failure (CARRIER_TICKET)
Match Pattern: message CONTAINS "[CARRIER_TICKET]"
Severity: Critical
Action:
  - Create incident ticket (ServiceNow/etc)
  - Notify NOC
  - Notify On-Call
Suppression: None (always alert)
Auto-Clear: When cleared event received
```

**Implementation Steps:**
1. Create Event Policy in SL1 System > Events > Event Policies
2. Set Pattern Type: "Contains"
3. Set Match String: `[CARRIER_TICKET]`
4. Set Severity: Critical (1)
5. Enable "Create Ticket" action
6. Add notification actions for NOC and On-Call

### Policy 2: BANDWIDTH_REVIEW - Capacity Issues

**Purpose:** Handle bandwidth/capacity events requiring planning review

```
Name: Prisma SD-WAN - Bandwidth Review
Match Pattern: message CONTAINS "[BANDWIDTH_REVIEW]"
Severity: Major
Action:
  - Create ticket (optional, configurable)
  - Notify Capacity Planning team
Suppression: 15 minutes (avoid flapping)
Auto-Clear: When cleared event received
```

**Implementation Steps:**
1. Create Event Policy in SL1
2. Set Pattern Type: "Contains"
3. Set Match String: `[BANDWIDTH_REVIEW]`
4. Set Severity: Major (2)
5. Enable notification to Capacity Planning team
6. Set suppression interval: 15 minutes

### Policy 3: INVESTIGATE - Network Issues

**Purpose:** Handle network events requiring root cause analysis

```
Name: Prisma SD-WAN - Investigation Required
Match Pattern: message CONTAINS "[INVESTIGATE]"
Severity: Major
Action:
  - Create incident ticket
  - Notify NOC
Suppression: 5 minutes
Auto-Clear: When cleared event received
```

**Implementation Steps:**
1. Create Event Policy in SL1
2. Set Pattern Type: "Contains"
3. Set Match String: `[INVESTIGATE]`
4. Set Severity: Major (2)
5. Enable "Create Ticket" action
6. Add notification for NOC
7. Set suppression interval: 5 minutes

### Policy 4: INFORMATIONAL - Suppress Downstream Events

**Purpose:** Suppress informational events (ANYNETLINK, VPNLINK) that don't require action

```
Name: Prisma SD-WAN - Informational (Suppress)
Match Pattern: message CONTAINS "[INFORMATIONAL]"
Severity: Info
Action:
  - Log only
  - No ticket
  - No notification
Suppression: N/A (info only)
Auto-Clear: Yes
```

**Implementation Steps:**
1. Create Event Policy in SL1
2. Set Pattern Type: "Contains"
3. Set Match String: `[INFORMATIONAL]`
4. Set Severity: Info (5)
5. Disable all actions (log only)
6. This ensures downstream events are logged but don't generate noise

### Policy 5: Site Administrative State

**Purpose:** Handle site disabled/enabled alerts from Site Config DA

```
Name: Prisma SD-WAN - Site Disabled
Match Alert: a_2196 (Prisma Cloud Site is Disabled)
Severity: Warning
Action:
  - Notify Site Admin
Suppression: None
Auto-Clear: When a_2197 fires

Name: Prisma SD-WAN - Site Enabled
Match Alert: a_2197 (Prisma Cloud Site is Active)
Severity: Info
Action:
  - Clear "Site Disabled" event
Suppression: N/A
```

**Note:** These are handled by DA alerts, not Event Policies. No additional configuration needed if alerts 2196/2197 are enabled.

## Policies to Remove/Disable

### Remove: Generic "Interface Down" Policies

If there are existing generic interface down policies that would match Prisma events:

```
REMOVE/DISABLE:
  - Any policy matching "interface" + "down" generically
  - Reason: Would duplicate CARRIER_TICKET alerts

KEEP:
  - CARRIER_TICKET policy (handles interface failures properly)
```

### Remove: Legacy CloudGenix Policies

If migrating from CloudGenix to Prisma SASE, remove old policies:

```
REMOVE:
  - CloudGenix API Error
  - CloudGenix Site Down
  - CloudGenix Device Offline

REASON: Replaced by Prisma SD-WAN policies
```

## Policy Priority Order

Event Policies should be ordered by specificity:

```
Priority  Policy Name                              Action
--------  ---------------------------------------  ----------------
1         Prisma SD-WAN - Circuit Failure          Ticket + Notify
2         Prisma SD-WAN - Investigation Required   Ticket + Notify
3         Prisma SD-WAN - Bandwidth Review         Notify
4         Prisma SD-WAN - Informational            Log Only
5         (Generic catch-all policies)             Varies
```

## Notification Groups

### Required Groups

| Group Name | Members | Receives |
|------------|---------|----------|
| NOC | Network Operations Center | CARRIER_TICKET, INVESTIGATE |
| On-Call | On-call engineer | CARRIER_TICKET (critical only) |
| Capacity Planning | Capacity team | BANDWIDTH_REVIEW |
| Site Admin | Site administrators | Site Disabled |

## Testing Checklist

After implementing Event Policies, verify:

- [ ] CARRIER_TICKET events create tickets
- [ ] CARRIER_TICKET events notify NOC
- [ ] BANDWIDTH_REVIEW events notify Capacity team
- [ ] INVESTIGATE events create tickets
- [ ] INFORMATIONAL events are logged but don't notify
- [ ] Site Disabled events notify Site Admin
- [ ] No duplicate alerts from multiple policies
- [ ] Cleared events properly clear active alerts

## Monitoring Dashboard

Recommended dashboard widgets for operations:

1. **Active Alerts by Classification**
   - Count of CARRIER_TICKET (should be 0 normally)
   - Count of INVESTIGATE (should be 0 normally)
   - Count of BANDWIDTH_REVIEW (review trends)

2. **Alert Trend (24h)**
   - Graph of alerts by classification over time
   - Identify patterns (recurring issues, time-of-day spikes)

3. **Top Sites by Alerts**
   - Sites with most alerts (identify problem sites)

4. **Event Processor Health**
   - Events processed per cycle
   - Match rate (matched vs unmatched events)

## Implementation Timeline

```
Phase 1: Core Policies (Day 1)
  - Create CARRIER_TICKET policy
  - Create INVESTIGATE policy
  - Test with sample events

Phase 2: Secondary Policies (Day 2)
  - Create BANDWIDTH_REVIEW policy
  - Create INFORMATIONAL (suppress) policy
  - Configure notification groups

Phase 3: Cleanup (Day 3)
  - Remove/disable legacy policies
  - Verify no duplicate alerts
  - Document final configuration

Phase 4: Monitoring (Week 1)
  - Monitor alert volumes
  - Tune suppression intervals
  - Adjust notification recipients
```

## SQL Queries for Verification

### Check Current Event Policies

```sql
-- List all event policies related to Prisma
SELECT policy_id, name, pattern, severity, state
FROM master.event_policy
WHERE name LIKE '%Prisma%' OR pattern LIKE '%CARRIER%' OR pattern LIKE '%INVESTIGATE%';
```

### Check Alert Activity

```sql
-- Count recent alerts by classification
SELECT
  SUBSTRING_INDEX(SUBSTRING_INDEX(message, ']', 1), '[', -1) as classification,
  COUNT(*) as count
FROM master.events
WHERE message LIKE '[%'
  AND timestamp > DATE_SUB(NOW(), INTERVAL 24 HOUR)
GROUP BY classification;
```

### Verify Event Processor Output

```sql
-- Check Event Processor collection results
SELECT did, collection_time, o_name, o_value
FROM silo_data.performance_raw
WHERE aid = 1730
  AND collection_time > DATE_SUB(NOW(), INTERVAL 1 HOUR)
ORDER BY collection_time DESC;
```

---

*Document Version: 1.0*
*Last Updated: 2026-01-08*

## Summary of Changes

### Create (New Policies)
1. Prisma SD-WAN - Circuit Failure (CARRIER_TICKET)
2. Prisma SD-WAN - Bandwidth Review
3. Prisma SD-WAN - Investigation Required
4. Prisma SD-WAN - Informational (Suppress)

### Update (Existing Items)
1. Verify DA alerts 2196/2197 are enabled (Site Config)
2. Consider enabling DA alerts 2194/2195 (Credential Check) if monitoring desired

### Remove (Legacy Items)
1. Any generic interface down policies that would duplicate CARRIER_TICKET
2. Legacy CloudGenix policies if migrating
3. Any policies that match ANYNETLINK/VPNLINK directly (now handled as INFORMATIONAL)
