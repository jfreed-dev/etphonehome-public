# ET Phone Home - Docker Compose Configuration
#
# Usage:
#   docker-compose up -d              # Start server
#   docker-compose --profile client up # Start with client
#   docker-compose logs -f            # View logs
#
# For production, set environment variables or use .env file

services:
  server:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.server
    image: etphonehome-server:latest
    container_name: etphonehome-server
    restart: unless-stopped
    ports:
      - "${ETPHONEHOME_PORT:-8765}:8765"
      - "${SSH_PORT:-2222}:22"
    environment:
      - ETPHONEHOME_LOG_LEVEL=${ETPHONEHOME_LOG_LEVEL:-INFO}
      - ETPHONEHOME_API_KEY=${ETPHONEHOME_API_KEY:-}
      - ETPHONEHOME_LOG_FILE=/var/log/etphonehome/server.log
      - ETPHONEHOME_LOG_MAX_BYTES=${ETPHONEHOME_LOG_MAX_BYTES:-10485760}
      - ETPHONEHOME_LOG_BACKUP_COUNT=${ETPHONEHOME_LOG_BACKUP_COUNT:-5}
    volumes:
      - server-data:/var/lib/etphonehome
      - server-logs:/var/log/etphonehome
      - ${SSH_HOST_KEYS:-./ssh_host_keys}:/etc/ssh/keys:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - etphonehome

  # SSH server for client connections (optional, run with --profile ssh)
  ssh:
    image: linuxserver/openssh-server:latest
    container_name: etphonehome-ssh
    profiles:
      - ssh
    restart: unless-stopped
    ports:
      - "${SSH_PORT:-2222}:2222"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-UTC}
      - USER_NAME=etphonehome
      - PUBLIC_KEY_FILE=/config/authorized_keys
      - SUDO_ACCESS=false
      - PASSWORD_ACCESS=false
    volumes:
      - ssh-config:/config
      - ${AUTHORIZED_KEYS_FILE:-./authorized_keys}:/config/authorized_keys:ro
    networks:
      - etphonehome

  # Client container (optional, run with --profile client)
  client:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.client
    image: etphonehome-client:latest
    container_name: etphonehome-client
    profiles:
      - client
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - client-config:/home/etphonehome/.etphonehome
      - ${CLIENT_SSH_KEY:-./client_key}:/home/etphonehome/.etphonehome/id_ed25519:ro
    depends_on:
      - server
    networks:
      - etphonehome

volumes:
  server-data:
  server-logs:
  ssh-config:
  client-config:

networks:
  etphonehome:
    driver: bridge
